---
layout: default
title: Review a Listing
permalink: /review.html
---
<section class="form-page">
  <header class="collection-index__header">
    <p class="eyebrow">Reviews</p>
    <h1>Review this Place</h1>
    <p class="lead">Share your experience and help keep the directory accurate. On submit, your email client will open with the review details.</p>
  </header>

  <form id="reviewForm">
    <div class="form-group">
      <label for="business_name">Business name</label>
      <input type="text" id="business_name" name="business_name" required>
    </div>

    <div class="form-group">
      <label>Star rating</label>
      <div class="stars" role="radiogroup" aria-label="Star rating">
        {% for i in (1..5) %}
        <label class="star" aria-label="{{ i }} star">
          <input type="radio" name="rating" value="{{ i }}" {% if i == 5 %}checked{% endif %}>
          <span>★</span>
        </label>
        {% endfor %}
      </div>
    </div>

    <div class="form-group">
      <label for="review_title">Review title (optional)</label>
      <input type="text" id="review_title" name="review_title" placeholder="Short headline">
    </div>

    <div class="form-group">
      <label for="review_text">Your review or experience</label>
      <textarea id="review_text" name="review_text" rows="4" required></textarea>
    </div>

    <div class="form-group">
      <label for="corrections">Anything that’s changed or needs correcting? (optional)</label>
      <textarea id="corrections" name="corrections" rows="3"></textarea>
    </div>

    <div class="form-group split">
      <div>
        <label for="visit">When did you last visit? (optional)</label>
        <input type="date" id="visit" name="visit">
      </div>
      <div>
        <label for="reviewer_name">Your name (optional)</label>
        <input type="text" id="reviewer_name" name="reviewer_name">
      </div>
    </div>

    <input type="hidden" id="business_slug" name="business_slug">

    <button type="submit" class="button">Send via email</button>
  </form>
</section>

<script>
  (function() {
    const params = new URLSearchParams(window.location.search);
    const listingParam = params.get('listing') || '';
    const presetName = params.get('name');
    const nameField = document.getElementById('business_name');
    const slugField = document.getElementById('business_slug');
    const slugify = (value) =>
      (value || '')
        .toLowerCase()
        .trim()
        .replace(/[^a-z0-9\s-]/g, '')
        .replace(/\s+/g, '-')
        .replace(/-+/g, '-');

    const decodedListing = listingParam ? decodeURIComponent(listingParam.replace(/\+/g, ' ')) : '';
    const presetBusinessName = presetName || decodedListing;
    if (presetBusinessName && nameField) {
      nameField.value = presetBusinessName;
    }
    if (slugField && listingParam) {
      slugField.value = listingParam;
    }

    const form = document.getElementById('reviewForm');
    form.addEventListener('submit', (e) => {
      e.preventDefault();
      const data = new FormData(form);
      const business = data.get('business_name') || '';
      const listingHint = params.get('listing') || '';
      let slug = '';

      if (listingHint) {
        slug = listingHint;
      } else {
        slug = slugify(business);
      }

      if (slugField) slugField.value = slug;
      const rating = data.get('rating') || '5';
      const subject = `[HOMEGROWN] REVIEW: ${business}`;
      const reviewText = (data.get('review_text') || '').trim();
      const corrections = (data.get('corrections') || '').trim();
      const bodyLines = [
        '# ACTION: NEW_REVIEW',
        '',
        `business_name: ${business}`,
        `business_slug: ${slug}`,
        `rating: ${rating}`,
        `last_visit_date: ${data.get('visit') || ''}`,
        `review_title: ${data.get('review_title') || ''}`,
        'review_text: |',
        `  ${reviewText.replace(/\r?\n/g, '\n  ')}`,
        '',
        'corrections_or_updates: |',
        `  ${corrections.replace(/\r?\n/g, '\n  ')}`,
        '',
        `reviewer_name: ${data.get('reviewer_name') || ''}`,
        `reviewer_email: ${data.get('reviewer_email') || ''}`,
        `relationship_to_business: ${data.get('relationship') || ''}`,
        'ok_to_publish: yes'
      ];
      const mailto = `mailto:josh@stonetosky.nz?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(bodyLines.join('\n'))}`;
      window.location.href = mailto;
    });
  })();
</script>

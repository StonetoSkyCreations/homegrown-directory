{% assign listing = include.listing | default: include.item | default: listing %}
{% assign practices_tags = listing.practices_tags | default: listing.practices | default: listing.sourcing_tags | default: listing.services | default: empty %}
{% assign practices_joined = practices_tags | join: ',' %}
{% assign products_array = "" | split: "" %}
{% if listing.products_tags %}
  {% assign products_array = products_array | concat: listing.products_tags %}
{% endif %}
{% if listing.products %}
  {% assign products_array = products_array | concat: listing.products %}
{% endif %}
{% assign cleaned_products = "" | split: "" %}
{% for product in products_array %}
  {% assign product_clean = product | strip %}
  {% if product_clean != "" %}
    {% assign cleaned_products = cleaned_products | push: product_clean %}
  {% endif %}
{% endfor %}
{% assign products_array = cleaned_products | uniq %}
{% assign products_array = products_array | uniq %}
{% assign review_target = listing.slug | default: listing.title | default: listing.name | slugify %}
{% assign card_title = listing.title | default: listing.name %}
{% assign encoded_title = card_title | uri_escape %}
{% assign collection_key = listing.collection | downcase %}
{% assign card_label = collection_key | capitalize %}
{% assign type_token = collection_key %}
{% assign subtype_raw = listing.subtype | default: listing.type | default: listing.listing_type | default: listing.category %}
{% assign address_parts = "" | split: "" %}
{% if listing.address %}{% assign address_parts = address_parts | push: listing.address %}{% endif %}
{% if listing.suburb %}{% assign address_parts = address_parts | push: listing.suburb %}{% endif %}
{% if listing.city or listing.city_town %}{% assign address_parts = address_parts | push: listing.city | default: listing.city_town %}{% endif %}
{% if listing.region %}{% assign address_parts = address_parts | push: listing.region %}{% endif %}
{% if listing.country %}{% assign address_parts = address_parts | push: listing.country %}{% endif %}
{% assign card_address = address_parts | join: ', ' %}
{% assign location_city = listing.city | default: listing.city_town | default: '' %}
{% assign location_region = listing.region | default: '' %}
{% assign card_location = '' %}
{% if location_city != '' and location_region != '' %}
  {% assign card_location = location_city | append: ', ' | append: location_region %}
{% elsif location_city != '' %}
  {% assign card_location = location_city %}
{% elsif location_region != '' %}
  {% assign card_location = location_region %}
{% endif %}
{% assign has_street = false %}
{% if listing.address and listing.address != '' %}
  {% assign has_street = true %}
{% endif %}
{% assign has_coords = false %}
{% if listing.lat and listing.lon and listing.lat != '' and listing.lon != '' %}
  {% assign has_coords = true %}
{% endif %}
{% assign map_query = card_address | uri_escape %}
{% assign summary_text = listing.description | default: listing.excerpt | strip_html | strip %}
{% case collection_key %}
  {% when 'stores' %}
    {% assign type_token = 'grocer' %}
    {% assign card_label = 'Grocer' %}
  {% when 'restaurants' %}
    {% assign type_token = 'restaurant' %}
    {% assign card_label = 'Eatery' %}
  {% when 'vendors' %}
    {% assign type_token = 'restaurant' %}
    {% assign card_label = 'Eatery' %}
  {% when 'markets' %}
    {% assign type_token = 'market' %}
    {% assign card_label = 'Market' %}
  {% when 'farms' %}
    {% assign type_token = 'farm' %}
    {% assign card_label = 'Farm' %}
  {% when 'distributors' %}
    {% assign type_token = 'distributor' %}
    {% assign card_label = 'Hub' %}
{% endcase %}
{% assign subtype_token = subtype_raw | default: type_token | slugify %}
{%- assign card_classes = "listing-card" -%}
{%- if include.featured -%}
  {%- assign card_classes = card_classes | append: " listing-card--featured" -%}
{%- endif -%}

{%- comment -%}
Filters read:
- data-collection: canonical type token per collection (farm, market, grocer, restaurant, distributor)
- data-type/data-subtype: subtype tokens used on directory pages (cafe, restaurant, vineyard, etc.)
- data-region/data-country: geographic filters use these values
- data-practices: comma-joined practices/products/services for tag filters
- data-products: comma-joined product tokens (products_tags > products)
{%- endcomment -%}
<article class="{{ card_classes }}"
  data-slug="{{ listing.slug | escape }}"
  data-region="{{ listing.region | escape }}"
  data-city="{{ listing.city | default: listing.city_town | escape }}"
  data-name="{{ card_title | escape }}"
  data-type="{{ subtype_token | escape }}"
  data-subtype="{{ subtype_token | escape }}"
  data-collection="{{ type_token | escape }}"
  data-category="{{ type_token | escape }}"
  data-country="{{ listing.country_slug | escape }}"
  data-lat="{{ listing.lat | default: '' }}"
  data-lon="{{ listing.lon | default: '' }}"
  data-practices="{{ practices_joined | downcase | escape }}"
  data-products="{% if products_array and products_array != empty %}{{ products_array | join: ',' | downcase }}{% endif %}">
  <div class="listing-card__meta">
    <span class="badge badge--meta badge--type">
      {% include icon.html name=type_token %}
      {{ card_label }}
    </span>
    {% if include.featured %}
      <span class="badge badge--verified badge--featured">Featured</span>
    {% endif %}
  </div>
  <h3 class="listing-card__title"><a href="{{ listing.url | relative_url }}">{{ card_title }}</a></h3>
  <div class="listing-card__location-block">
    {% if has_street or has_coords %}
      <a class="listing-card__location-link"
        href="https://www.google.com/maps/search/?api=1&query={{ card_address | uri_escape }}"
        target="_blank"
        rel="noopener">
        <span class="listing-card__location">{{ card_location | default: "View on map" }}</span>
      </a>
    {% else %}
      <span class="listing-card__location muted">{{ card_location | default: "Location not provided" }}</span>
    {% endif %}
    <p class="listing-card__distance" data-distance hidden></p>
  </div>
  <div class="listing-card__tags">
    {% if practices_tags and practices_tags.size > 0 %}
    <ul class="tag-list">
      {% for tag in practices_tags limit: 4 %}
      <li>{{ tag }}</li>
      {% endfor %}
    </ul>
    {% else %}
    <p class="muted">Learn more.</p>
    {% endif %}
  </div>
  {% if summary_text != "" %}
    <p class="listing-card__summary">{{ summary_text | truncate: 130 }}</p>
  {% endif %}
  {% include rating.html listing=listing %}
  <div class="listing-card__actions">
    <a class="text-link" href="{{ listing.url | relative_url }}">Learn more</a>
  </div>
</article>

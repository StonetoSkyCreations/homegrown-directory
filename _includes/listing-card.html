{% assign practices_tags = listing.practices | default: listing.practices_tags | default: listing.sourcing_tags | default: listing.services | default: empty %}
{% assign practices_joined = practices_tags | join: ',' %}
{% assign review_target = listing.slug | default: listing.title | default: listing.name | slugify %}
{% assign card_title = listing.title | default: listing.name %}
{% assign encoded_title = card_title | uri_escape %}
{% assign card_type = listing.collection %}
{% assign card_label = card_type | capitalize %}
{% assign address_parts = "" | split: "" %}
{% if listing.address %}{% assign address_parts = address_parts | push: listing.address %}{% endif %}
{% if listing.suburb %}{% assign address_parts = address_parts | push: listing.suburb %}{% endif %}
{% if listing.city or listing.city_town %}{% assign address_parts = address_parts | push: listing.city | default: listing.city_town %}{% endif %}
{% if listing.region %}{% assign address_parts = address_parts | push: listing.region %}{% endif %}
{% if listing.country %}{% assign address_parts = address_parts | push: listing.country %}{% endif %}
{% assign card_address = address_parts | join: ', ' %}
{% assign has_coords = listing.lat and listing.lon %}
{% assign has_street = listing.address %}
{% assign map_query = card_address | uri_escape %}
{% case listing.collection %}
  {% when 'stores' %}
    {% assign card_type = 'grocer' %}
    {% assign card_label = 'Grocer' %}
  {% when 'restaurants' %}
    {% assign card_type = 'eatery' %}
    {% assign card_label = 'Eatery' %}
  {% when 'vendors' %}
    {% assign card_type = 'eatery' %}
    {% assign card_label = 'Eatery' %}
  {% when 'markets' %}
    {% assign card_type = 'market' %}
    {% assign card_label = 'Market' %}
  {% when 'farms' %}
    {% assign card_type = 'farm' %}
    {% assign card_label = 'Farm' %}
  {% when 'distributors' %}
    {% assign card_type = 'hub' %}
    {% assign card_label = 'Hub' %}
{% endcase %}
<article class="listing-card"
  data-region="{{ listing.region | escape }}"
  data-city="{{ listing.city | default: listing.city_town | escape }}"
  data-name="{{ card_title | escape }}"
  data-type="{{ listing.type | default: listing.collection | escape }}"
  data-category="{{ card_type | escape }}"
  data-country="{{ listing.country_slug | escape }}"
  data-practices="{{ practices_joined | escape }}">
  <div class="listing-card__meta">
    <span class="pill pill--type">{{ card_label }}</span>
    {% if has_coords %}
      <a class="listing-card__location-link" href="https://www.google.com/maps/search/?api=1&query={{ listing.lat }},{{ listing.lon }}" target="_blank" rel="noopener">
        <span class="listing-card__location">{{ card_address | default: 'View on map' }}</span>
      </a>
    {% elsif has_street %}
      <a class="listing-card__location-link" href="https://www.google.com/maps/search/?api=1&query={{ map_query }}" target="_blank" rel="noopener">
        <span class="listing-card__location">{{ card_address }}</span>
      </a>
    {% else %}
      {% if card_address != "" %}
        <span class="listing-card__location muted">{{ card_address }}</span>
      {% else %}
        <span class="listing-card__location muted">Location not provided</span>
      {% endif %}
    {% endif %}
  </div>
  <h3 class="listing-card__title"><a href="{{ listing.url | relative_url }}">{{ card_title }}</a></h3>
  <p class="listing-card__summary">{{ listing.description | default: listing.excerpt | strip_html | truncate: 130 }}</p>
  <div class="listing-card__tags">
    {% if practices_tags and practices_tags.size > 0 %}
    <ul class="tag-list">
      {% for tag in practices_tags limit: 4 %}
      <li>{{ tag }}</li>
      {% endfor %}
    </ul>
    {% else %}
    <p class="muted">Learn more.</p>
    {% endif %}
    {% include rating.html listing=listing %}
    <div class="listing-card__actions">
      <a class="button ghost" href="{{ listing.url | relative_url }}">Learn more</a>
      <a class="button ghost" href="{{ '/submit.html?submission_type=update&listing=' | append: review_target | append: '&name=' | append: encoded_title | relative_url }}">Update listing</a>
      <a class="button ghost" href="{{ '/review.html?listing=' | append: review_target | relative_url }}">Review this place</a>
    </div>
  </div>
</article>

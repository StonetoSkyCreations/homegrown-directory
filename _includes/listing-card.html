{% assign listing = include.listing | default: include.item | default: listing %}
{% assign practices_tags = listing.practices | default: listing.practices_tags | default: listing.sourcing_tags | default: listing.services | default: empty %}
{% assign practices_joined = practices_tags | join: ',' %}
{% assign review_target = listing.slug | default: listing.title | default: listing.name | slugify %}
{% assign card_title = listing.title | default: listing.name %}
{% assign encoded_title = card_title | uri_escape %}
{% assign collection_key = listing.collection | downcase %}
{% assign card_label = collection_key | capitalize %}
{% assign type_token = collection_key %}
{% assign subtype_raw = listing.type | default: listing.listing_type | default: listing.category %}
{% assign address_parts = "" | split: "" %}
{% if listing.address %}{% assign address_parts = address_parts | push: listing.address %}{% endif %}
{% if listing.suburb %}{% assign address_parts = address_parts | push: listing.suburb %}{% endif %}
{% if listing.city or listing.city_town %}{% assign address_parts = address_parts | push: listing.city | default: listing.city_town %}{% endif %}
{% if listing.region %}{% assign address_parts = address_parts | push: listing.region %}{% endif %}
{% if listing.country %}{% assign address_parts = address_parts | push: listing.country %}{% endif %}
{% assign card_address = address_parts | join: ', ' %}
{% assign has_street = listing.address and listing.address != '' %}
{% assign has_coords = listing.lat and listing.lon and listing.lat != '' and listing.lon != '' %}
{% assign map_query = card_address | uri_escape %}
{% case collection_key %}
  {% when 'stores' %}
    {% assign type_token = 'grocer' %}
    {% assign card_label = 'Grocer' %}
  {% when 'restaurants' %}
    {% assign type_token = 'restaurant' %}
    {% assign card_label = 'Eatery' %}
  {% when 'vendors' %}
    {% assign type_token = 'restaurant' %}
    {% assign card_label = 'Eatery' %}
  {% when 'markets' %}
    {% assign type_token = 'market' %}
    {% assign card_label = 'Market' %}
  {% when 'farms' %}
    {% assign type_token = 'farm' %}
    {% assign card_label = 'Farm' %}
  {% when 'distributors' %}
    {% assign type_token = 'distributor' %}
    {% assign card_label = 'Hub' %}
{% endcase %}
{% assign subtype_token = subtype_raw | default: type_token | slugify %}
{%- assign card_classes = "listing-card" -%}
{%- if include.featured -%}
  {%- assign card_classes = card_classes | append: " listing-card--featured" -%}
{%- endif -%}

{%- comment -%}
Filters read:
- data-collection: canonical type token per collection (farm, market, grocer, restaurant, distributor)
- data-type/data-subtype: subtype tokens used on directory pages (cafe, restaurant, vineyard, etc.)
- data-region/data-country: geographic filters use these values
- data-practices: comma-joined practices/products/services for tag filters
{%- endcomment -%}
<article class="{{ card_classes }}"
  data-region="{{ listing.region | escape }}"
  data-city="{{ listing.city | default: listing.city_town | escape }}"
  data-name="{{ card_title | escape }}"
  data-type="{{ subtype_token | escape }}"
  data-subtype="{{ subtype_token | escape }}"
  data-collection="{{ type_token | escape }}"
  data-category="{{ type_token | escape }}"
  data-country="{{ listing.country_slug | escape }}"
  data-practices="{{ practices_joined | escape }}">
  <div class="listing-card__meta">
    <div>
      <span class="pill pill--type">{{ card_label }}</span>
      {% if include.featured %}
        <span class="featured-badge">‚≠ê Featured</span>
      {% endif %}
    </div>
    {% if has_street or has_coords %}
      <a class="listing-card__location-link"
        href="https://www.google.com/maps/search/?api=1&query={{ card_address | uri_escape }}"
        target="_blank"
        rel="noopener">
        <span class="listing-card__location">{{ card_address | default: "View on map" }}</span>
      </a>
    {% elsif card_address != "" %}
      <span class="listing-card__location muted">{{ card_address }}</span>
    {% else %}
      <span class="listing-card__location muted">Location not provided</span>
    {% endif %}
  </div>
  <h3 class="listing-card__title"><a href="{{ listing.url | relative_url }}">{{ card_title }}</a></h3>
  <p class="listing-card__summary">{{ listing.description | default: listing.excerpt | strip_html | truncate: 130 }}</p>
  <div class="listing-card__tags">
    {% if practices_tags and practices_tags.size > 0 %}
    <ul class="tag-list">
      {% for tag in practices_tags limit: 4 %}
      <li>{{ tag }}</li>
      {% endfor %}
    </ul>
    {% else %}
    <p class="muted">Learn more.</p>
    {% endif %}
    {% include rating.html listing=listing %}
    <div class="listing-card__actions">
      <a class="button ghost" href="{{ listing.url | relative_url }}">Learn more</a>
    </div>
  </div>
</article>

{% comment %}
SEO/AEO meta builder
- Use `page.seo_title` / `page.seo_description` to override defaults.
- Falls back to dynamic titles/descriptions using page type, location, and practices.
- Keeps HTML structure untouched while improving search + AI answer quality.
{% endcomment %}
{% assign site_name = site.title | default: "Homegrown Directory" %}
{% assign location_parts = "" | split: "" %}
{% if page.city %}{% assign location_parts = location_parts | push: page.city %}{% endif %}
{% if page.region %}{% assign location_parts = location_parts | push: page.region %}{% endif %}
{% if page.country %}{% assign location_parts = location_parts | push: page.country %}{% endif %}
{% assign location_text = location_parts | uniq | join: ", " %}

{% assign practices_source = page.practices | default: page.practices_tags | default: page.sourcing_tags | default: empty %}
{% assign primary_practice = practices_source[0] | default: "" %}

{% assign type_label = page.type | default: page.collection | default: 'Page' %}
{% assign type_token = page.type | default: page.subtype | default: page.category | default: page.collection | default: '' | downcase %}
{% case page.collection %}
  {% when 'stores' %}
    {% assign type_label = 'Store' %}
    {% if type_token contains 'grocery' or type_token contains 'grocer' or type_token contains 'supermarket' %}
      {% assign type_label = 'Grocery Store' %}
    {% endif %}
  {% when 'restaurants' %}
    {% assign type_label = 'Restaurant' %}
  {% when 'vendors' %}
    {% assign type_label = 'Vendor' %}
    {% if type_token contains 'restaurant' or type_token contains 'cafe' %}
      {% assign type_label = 'Restaurant' %}
    {% endif %}
  {% when 'markets' %}
    {% assign type_label = 'Market' %}
  {% when 'farms' %}
    {% assign type_label = 'Farm' %}
  {% when 'distributors' %}
    {% assign type_label = 'Distributor' %}
  {% else %}
    {% assign type_label = page.type | default: page.collection | default: 'Page' %}
{% endcase %}

{%- assign raw_desc = page.seo_description
  | default: page.summary
  | default: page.description
  | default: page.intro
  | default: page.excerpt
  | default: site.description
-%}
{%- assign cleaned_desc = raw_desc
  | markdownify
  | strip_html
  | strip_newlines
  | replace: "  ", " "
  | replace: "  ", " "
  | strip
-%}

{%- assign max_chars = 158 -%}
{%- assign truncated_desc = cleaned_desc -%}
{%- assign truncation_applied = false -%}
{%- if cleaned_desc and cleaned_desc.size > max_chars -%}
  {%- assign truncated_desc = cleaned_desc | truncatewords: 32, "" | strip -%}
  {%- if truncated_desc.size > max_chars -%}
    {%- assign truncated_desc = cleaned_desc | truncatewords: 28, "" | strip -%}
  {%- endif -%}
  {%- assign truncation_applied = true -%}
{%- endif -%}
{%- if truncation_applied -%}
  {%- assign truncated_desc = truncated_desc | append: "…" -%}
  {%- assign truncated_desc = truncated_desc
    | replace: " -…", "…"
    | replace: "-…", "…"
    | replace: " –…", "…"
    | replace: " —…", "…"
    | replace: ",…", "…"
    | replace: ";…", "…"
    | replace: ":…", "…"
    | replace: " …", "…"
  -%}
{%- endif -%}

{%- assign loc_parts = "" | split: "" -%}
{%- if page.city %}{% assign loc_parts = loc_parts | push: page.city %}{% endif -%}
{%- if page.region %}{% assign loc_parts = loc_parts | push: page.region %}{% endif -%}
{%- assign loc_text = loc_parts | join: ", " -%}

{% capture desc_with_context %}
  {% if page.collection and page.collection != 'posts' %}
    {{ page.title | default: type_label }}{% if loc_text != "" %} in {{ loc_text }}{% endif %}. {{ truncated_desc }}
  {% else %}
    {{ truncated_desc }}
  {% endif %}
{% endcapture %}
{% assign page_description = desc_with_context | strip | replace: "  ", " " | replace: "  ", " " %}

{% assign display_name = page.title | default: page.name | default: site_name %}
{% assign loc_for_title = "" %}
{% if page.city %}
  {% assign loc_for_title = page.city %}
  {% if page.region %}{% assign loc_for_title = loc_for_title | append: ", " | append: page.region %}{% endif %}
{% elsif page.region %}
  {% assign loc_for_title = page.region %}
{% endif %}

{% capture auto_title %}
  {% if page.collection and page.collection != 'posts' %}
    {{ display_name }} — {{ type_label }}{% if loc_for_title != "" %} in {{ loc_for_title }}{% endif %} | {{ site_name }}
  {% elsif page.layout == 'home' or page.url == '/' %}
    {{ site_name }} — {{ site.tagline | default: "Find food grown with care" }}
  {% elsif page.collection == 'posts' %}
    {{ page.title }} | Insights on organic and local food | {{ site_name }}
  {% else %}
    {{ display_name }} | {{ site.description | default: "Organic and local food directory" }} | {{ site_name }}
  {% endif %}
{% endcapture %}
{% assign page_title = page.seo_title | default: auto_title | strip | replace: "  ", " " %}
{% assign og_image = page.og_image | default: site.og_image | default: '/og-image.png' %}

<title>{{ page_title | escape }}</title>
<meta name="description" content="{{ page_description | escape }}">
<link rel="canonical" href="{{ page.url | absolute_url }}">
<meta property="og:title" content="{{ page_title | escape }}">
<meta property="og:description" content="{{ page_description | escape }}">
<meta property="og:url" content="{{ page.url | absolute_url }}">
<meta property="og:site_name" content="{{ site_name | escape }}">
<meta property="og:type" content="{% if page.collection == 'posts' or page.layout == 'blog_post' %}article{% else %}website{% endif %}">
<meta property="og:image" content="{{ og_image | absolute_url }}">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="{{ og_image | absolute_url }}">
<meta name="twitter:title" content="{{ page_title | escape }}">
<meta name="twitter:description" content="{{ page_description | escape }}">

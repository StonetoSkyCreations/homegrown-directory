---
layout: default
title: Add or Update a Listing
permalink: /submit.html
---
<section class="form-page">
  <header class="collection-index__header">
    <p class="eyebrow">Contribute</p>
    <h1>Add or Update a Listing</h1>
    <p class="lead">Use this form to add new farms, stores, cafés, restaurants, markets, or hubs, or to update an existing listing. On submit, your email client will open with the details prefilled.</p>
  </header>

  <form id="submitForm">
    <div class="form-group">
      <label>Submission type</label>
      <div class="pill-group">
        <label class="pill pill--checkbox">
          <input type="radio" name="submission_type" value="new" checked>
          <span>Add new listing</span>
        </label>
        <label class="pill pill--checkbox">
          <input type="radio" name="submission_type" value="update">
          <span>Update existing listing</span>
        </label>
      </div>
    </div>

    <div class="form-group">
      <label for="collection">Listing category</label>
      <select id="collection" name="collection" required>
        <option value="">Select a category…</option>
        <option value="farms">Farms &amp; producers</option>
        <option value="markets">Markets</option>
        <option value="stores">Grocers / stores</option>
        <option value="restaurants">Eateries (restaurants &amp; cafés)</option>
        <option value="vendors">Food trucks / mobile vendors</option>
        <option value="distributors">Distributors / hubs</option>
      </select>
    </div>

    <div class="form-group" id="subtype-group" style="display:none">
      <label for="subtype">Subtype</label>
      <select id="subtype" name="subtype">
        <option value="">Select a subtype…</option>
        <option data-collections="restaurants" value="cafe">Cafe</option>
        <option data-collections="restaurants" value="restaurant">Restaurant</option>
        <option data-collections="vendors" value="food-truck">Food truck</option>
        <option data-collections="stores" value="supermarket">Supermarket</option>
        <option data-collections="stores" value="organic-store">Organic store</option>
        <option data-collections="stores" value="wholefoods-store">Wholefoods store</option>
        <option data-collections="stores" value="bulk-refillery">Bulk refillery</option>
        <option data-collections="stores" value="co-op">Co-op</option>
        <option data-collections="stores" value="specialty-grocer">Specialty grocer</option>
        <option data-collections="farms" value="market-garden">Market garden</option>
        <option data-collections="farms" value="orchard">Orchard</option>
        <option data-collections="farms" value="vineyard">Vineyard</option>
        <option data-collections="farms" value="livestock">Livestock</option>
        <option data-collections="farms" value="dairy-farm">Dairy farm</option>
        <option data-collections="farms" value="apiary">Apiary / honey</option>
        <option data-collections="farms" value="eggs">Eggs</option>
        <option data-collections="farms" value="mushrooms">Mushrooms</option>
        <option data-collections="farms" value="seeds">Seeds / nursery</option>
        <option data-collections="farms" value="flowers">Flowers</option>
        <option data-collections="farms" value="mixed">Mixed</option>
      </select>
    </div>

    <div class="form-group" id="specialty-group" style="display:none">
      <label>Specialty (optional)</label>
      <div class="pill-group">
        {% assign specialty_tags = "bakery,butcher,fish-monger,chocolatier,kombucha,kefir,dairy,cheese,coffee-roaster,fermenter" | split: "," %}
        {% for tag in specialty_tags %}
        <label class="pill pill--checkbox">
          <input type="checkbox" name="specialty_tags" value="{{ tag }}">
          <span>{{ tag | replace: '-', ' ' | capitalize }}</span>
        </label>
        {% endfor %}
      </div>
    </div>

    <div class="form-group">
      <label for="name">Business name</label>
      <input type="text" id="name" name="name" required>
    </div>

    <div class="form-group split">
      <div>
        <label for="country_slug">Country</label>
        <select id="country_slug" name="country_slug">
          <option value="new-zealand" selected>New Zealand</option>
          <option value="australia">Australia</option>
        </select>
      </div>
      <div>
        <label for="region">Region</label>
        <input type="text" id="region" name="region" placeholder="e.g. Wellington">
      </div>
    </div>

    <div class="form-group split">
      <div>
        <label for="city">City / town</label>
        <input type="text" id="city" name="city" placeholder="e.g. Masterton">
      </div>
      <div>
        <label for="suburb">Suburb</label>
        <input type="text" id="suburb" name="suburb" placeholder="e.g. Brooklyn">
      </div>
    </div>

    <div class="form-group">
      <label for="address">Street address</label>
      <input type="text" id="address" name="address" placeholder="123 Example St">
    </div>

    <div class="form-group">
      <label for="postcode">Postcode (optional)</label>
      <input type="text" id="postcode" name="postcode" placeholder="e.g. 6011">
    </div>

    <div class="form-group split">
      <div>
        <label for="website">Website</label>
        <input type="url" id="website" name="website" placeholder="https://">
      </div>
      <div>
        <label for="social">Social links</label>
        <textarea id="social" name="social" rows="2" placeholder="https:// (one per line or comma separated)"></textarea>
      </div>
    </div>

    <div class="form-group split">
      <div>
        <label for="email">Contact email</label>
        <input type="email" id="email" name="email" placeholder="you@example.com">
      </div>
      <div>
        <label for="phone">Contact phone</label>
        <input type="text" id="phone" name="phone" placeholder="+64...">
      </div>
    </div>

    <div class="form-group">
      <label for="short_description">Short description (card preview)</label>
      <textarea id="short_description" name="short_description" rows="3" placeholder="Shows on the listing card; 1–2 sentences."></textarea>
    </div>

    <div class="form-group">
      <label for="full_description">Full description (for the main listing page)</label>
      <textarea id="full_description" name="full_description" rows="6" placeholder="Markdown accepted."></textarea>
    </div>

    <div class="form-group">
      <label>Practices</label>
      <div class="pill-group">
        {% assign practice_tokens = "organic,spray-free,regenerative,biodynamic,wild,pasture-raised,local" | split: "," %}
        {% for tag in practice_tokens %}
        <label class="pill pill--checkbox">
          <input type="checkbox" name="practices_tags" value="{{ tag }}">
          <span>{{ tag | replace: '-', ' ' | capitalize }}</span>
        </label>
        {% endfor %}
      </div>
    </div>

    <div class="form-group" id="farm-products-group" style="display:none">
      <label>Products (farms only)</label>
      <div class="pill-group">
        {% assign farm_products = "meat,dairy,seed" | split: "," %}
        {% for tag in farm_products %}
        <label class="pill pill--checkbox">
          <input type="checkbox" name="products_tags" value="{{ tag }}">
          <span>{{ tag | capitalize }}</span>
        </label>
        {% endfor %}
      </div>
    </div>

    <div class="form-group">
      <label for="products">Products (one per line or comma separated)</label>
      <textarea id="products" name="products" rows="3"></textarea>
    </div>

    <div class="form-group">
      <label for="services">Services / channels (one per line or comma separated)</label>
      <textarea id="services" name="services" rows="3"></textarea>
    </div>

    <div class="form-group split">
      <div>
        <label for="hours">Hours / schedule</label>
        <textarea id="hours" name="hours" rows="2" placeholder="e.g. Mon–Fri 9–5"></textarea>
      </div>
      <div>
        <label for="market_days">Market days (one per line)</label>
        <textarea id="market_days" name="market_days" rows="2" placeholder="e.g. Sat 8–12pm"></textarea>
      </div>
    </div>

    <div class="form-group split">
      <div>
        <label for="supplies_to">Who do they supply to? (optional)</label>
        <textarea id="supplies_to" name="supplies_to" rows="2"></textarea>
      </div>
      <div>
        <label for="sources">Who do they source from? (optional)</label>
        <textarea id="sources" name="sources" rows="2"></textarea>
      </div>
    </div>

    <div class="form-group">
      <label for="updates">What needs to be updated or corrected? (for updates)</label>
      <textarea id="updates" name="updates" rows="3"></textarea>
    </div>

    <div class="form-group">
      <label for="notes">Extra comments (anything else we should know)</label>
      <textarea id="notes" name="notes" rows="3"></textarea>
    </div>

    <input type="hidden" id="slug" name="slug">

    <button type="submit" class="button">Send via email</button>
  </form>
</section>

<script>
  const submitForm = document.getElementById('submitForm');
  const params = new URLSearchParams(window.location.search);
  const nameInput = document.getElementById('name');
  const slugInput = document.getElementById('slug');
  const submissionTypeRadios = submitForm.querySelectorAll('input[name="submission_type"]');
  const collectionSelect = document.getElementById('collection');
  const subtypeSelect = document.getElementById('subtype');
  const subtypeGroup = document.getElementById('subtype-group');
  const farmProductsGroup = document.getElementById('farm-products-group');
  const specialtyGroup = document.getElementById('specialty-group');

  // Canonical tokens: collection (farms, markets, stores, restaurants, vendors, distributors)
  // subtype is only emitted for restaurants/vendors/stores; markets have no subtype.
  // practices_tags always emitted (even empty). products_tags only for farms. specialty_tags only for stores + specialty-grocer.
  const PRACTICE_TOKENS = ['organic', 'spray-free', 'regenerative', 'biodynamic', 'wild', 'pasture-raised', 'local'];
  const FARM_PRODUCT_TOKENS = ['meat', 'dairy', 'seed'];
  const FARM_SUBTYPES = ['market-garden', 'orchard', 'vineyard', 'livestock', 'dairy-farm', 'apiary', 'eggs', 'mushrooms', 'seeds', 'flowers', 'mixed'];
  const RESTAURANT_SUBTYPES = ['cafe', 'restaurant'];
  const VENDOR_SUBTYPES = ['food-truck'];
  const STORE_SUBTYPES = ['supermarket', 'organic-store', 'wholefoods-store', 'bulk-refillery', 'co-op', 'specialty-grocer'];
  const SPECIALTY_TOKENS = ['bakery', 'butcher', 'fish-monger', 'chocolatier', 'kombucha', 'kefir', 'dairy', 'cheese', 'coffee-roaster', 'fermenter'];

  const listingRef = params.get('listing') || '';
  const presetName = params.get('name');
  const presetSubmissionType = params.get('submission_type');

  if (presetName && nameInput) {
    nameInput.value = presetName;
  } else if (listingRef && nameInput) {
    nameInput.value = listingRef;
  }
  if (listingRef && slugInput && !slugInput.value) {
    slugInput.value = listingRef;
  }

  const shouldSetUpdate =
    (presetSubmissionType && presetSubmissionType.toLowerCase().includes('update')) || Boolean(listingRef);
  if (shouldSetUpdate && submissionTypeRadios.length) {
    submissionTypeRadios.forEach((radio) => {
      radio.checked = radio.value === 'update';
    });
  }

  if (collectionSelect) {
    const presetCollection = params.get('collection');
    if (presetCollection) {
      collectionSelect.value = presetCollection;
    }
    collectionSelect.addEventListener('change', updateCategoryFields);
  }
  if (subtypeSelect) {
    subtypeSelect.addEventListener('change', updateCategoryFields);
  }
  updateCategoryFields();

  const slugify = (value) =>
    (value || '')
      .toLowerCase()
      .trim()
      .replace(/[^a-z0-9\s-]/g, '')
      .replace(/\s+/g, '-')
      .replace(/-+/g, '-');

  const normalizeToken = (value) => (value || '').toString().trim().toLowerCase();

  const splitList = (value) =>
    (value || '')
      .split(/[,\n]/)
      .map((v) => v.trim())
      .filter(Boolean);

  const uniqueAllowed = (values, allowed) => {
    const set = new Set();
    values.forEach((val) => {
      const token = normalizeToken(val);
      if (allowed.includes(token)) set.add(token);
    });
    return Array.from(set);
  };

  const getCheckedValues = (name, allowed) => {
    const values = Array.from(submitForm.querySelectorAll(`input[name="${name}"]:checked`)).map((el) => el.value);
    return uniqueAllowed(values, allowed);
  };

  const clearChecked = (name) => {
    submitForm.querySelectorAll(`input[name="${name}"]`).forEach((el) => {
      el.checked = false;
    });
  };

  function updateCategoryFields() {
    const collection = collectionSelect ? collectionSelect.value : '';
    const subtypeAllowedCollections = ['restaurants', 'vendors', 'stores', 'farms'];
    const showSubtype = subtypeAllowedCollections.includes(collection);
    if (subtypeGroup) subtypeGroup.style.display = showSubtype ? '' : 'none';
    if (subtypeSelect) {
      const current = subtypeSelect.value;
      let keepCurrent = false;
      Array.from(subtypeSelect.options).forEach((opt) => {
        if (!opt.value) {
          opt.hidden = false;
          return;
        }
        const allowedFor = (opt.dataset.collections || '').split(',').map((v) => v.trim());
        const allowed = allowedFor.includes(collection);
        opt.hidden = !allowed;
        if (!allowed && current === opt.value) {
          subtypeSelect.value = '';
        }
        if (allowed && current === opt.value) {
          keepCurrent = true;
        }
      });
      if (!keepCurrent && !showSubtype) {
        subtypeSelect.value = '';
      }
    }

    const isFarm = collection === 'farms';
    if (farmProductsGroup) farmProductsGroup.style.display = isFarm ? '' : 'none';
    if (!isFarm) clearChecked('products_tags');

    const showSpecialty = collection === 'stores' && subtypeSelect && subtypeSelect.value === 'specialty-grocer';
    if (specialtyGroup) specialtyGroup.style.display = showSpecialty ? '' : 'none';
    if (!showSpecialty) clearChecked('specialty_tags');
  }

  const formatList = (label, items) => {
    if (!items.length) return `${label}: []`;
    return `${label}:\n${items.map((item) => `  - ${item}`).join('\n')}`;
  };

  const formatMultiline = (label, value) => {
    const text = (value || '').trim();
    return `${label}: >\n  ${text.replace(/\r?\n/g, '\n  ')}`;
  };

  const buildYaml = (data, action, targetSlug = listingRef) => {
    const listFields = {
      products: splitList(data.get('products')),
      services: splitList(data.get('services')),
      social: splitList(data.get('social')),
      market_days: splitList(data.get('market_days')),
      supplies_to: splitList(data.get('supplies_to')),
      sources: splitList(data.get('sources'))
    };
    const name = data.get('name') || '';
    const countrySlug = data.get('country_slug') || 'new-zealand';
    const countryLabel = countrySlug === 'australia' ? 'AU' : 'New Zealand';
    const slug = targetSlug || slugify(name);
    const collection = data.get('collection') || '';
    const subtypeRaw = normalizeToken(data.get('subtype'));
    const practicesTags = uniqueAllowed(data.getAll('practices_tags'), PRACTICE_TOKENS);
  const productsTags = collection === 'farms' ? uniqueAllowed(data.getAll('products_tags'), FARM_PRODUCT_TOKENS) : [];
  const specialtyTags =
      collection === 'stores' && subtypeRaw === 'specialty-grocer'
        ? uniqueAllowed(data.getAll('specialty_tags'), SPECIALTY_TOKENS)
        : [];
  const subtypeAllowed =
      (collection === 'restaurants' && RESTAURANT_SUBTYPES.includes(subtypeRaw)) ||
      (collection === 'vendors' && VENDOR_SUBTYPES.includes(subtypeRaw)) ||
      (collection === 'stores' && STORE_SUBTYPES.includes(subtypeRaw)) ||
      (collection === 'farms' && FARM_SUBTYPES.includes(subtypeRaw));
    const subtype = subtypeAllowed ? subtypeRaw : '';
    const shortDescription = data.get('short_description') || '';
    const fullDescription = (data.get('full_description') || '').trim();
    const descriptionText = shortDescription || fullDescription;
    const submitterName = data.get('submitter_name') || '';
    const ownerName = data.get('owner_name') || '';

    const yamlLines = [
      '---',
      `title: ${name}`,
      `slug: ${slug}`,
      `collection: ${collection}`,
      subtype ? `subtype: ${subtype}` : null,
      `country_slug: ${countrySlug}`,
      `country: ${countryLabel}`,
      `region: ${data.get('region') || ''}`,
      `city: ${data.get('city') || ''}`,
      `address: ${data.get('address') || ''}`,
      `suburb: ${data.get('suburb') || ''}`,
      `postcode: ${data.get('postcode') || ''}`,
      formatMultiline('description', descriptionText),
      formatMultiline('seo_description', data.get('seo_description')),
      formatList('practices_tags', practicesTags),
      collection === 'farms' ? formatList('products_tags', productsTags) : null,
      collection === 'stores' && specialtyTags.length ? formatList('specialty_tags', specialtyTags) : null,
      formatList('products', listFields.products),
      formatList('services', listFields.services),
      `website: ${data.get('website') || ''}`,
      `email: ${data.get('email') || ''}`,
      `phone: ${data.get('phone') || ''}`,
      formatList('social', listFields.social),
      `hours: ${data.get('hours') || ''}`,
      formatList('market_days', listFields.market_days),
      formatList('supplies_to', listFields.supplies_to),
      formatList('sources', listFields.sources),
      '---'
    ];
    const yamlContent = yamlLines.filter(Boolean).join('\n');

    const ownerIsContact = data.get('owner_checkbox') ? 'yes' : 'no';
    const submitterNotes = [
      '# Submitter notes',
      `owner_is_contact: ${ownerIsContact}`,
      `owner_name: ${ownerName}`,
      `submitter_name: ${submitterName}`,
      `submitter_email: ${data.get('submitter_email') || ''}`
    ];
    if (action === 'update') {
      submitterNotes.push('what_changed: |');
      submitterNotes.push(`  ${(data.get('updates') || '').replace(/\r?\n/g, '\n  ')}`);
    } else {
      submitterNotes.push('extra_comments: |');
      submitterNotes.push(`  ${(data.get('notes') || '').replace(/\r?\n/g, '\n  ')}`);
    }

    const headerLines = [
      `# ACTION: ${action === 'update' ? 'UPDATE_LISTING' : 'NEW_LISTING'}`,
      action === 'update' ? `# TARGET_SLUG: ${targetSlug || slug}` : null
    ].filter(Boolean);

    const sections = [
      headerLines.join('\n'),
      yamlContent,
      '# Full description (markdown)',
      fullDescription || '[add long-form description here]',
      submitterNotes.join('\n')
    ];

    return sections.join('\n\n');
  };

  submitForm.addEventListener('submit', (e) => {
    e.preventDefault();
    const data = new FormData(submitForm);
    const subType = data.get('submission_type') || 'new';
    const name = data.get('name') || '';
    const targetSlug = listingRef || '';
    const slug = targetSlug || slugify(name);
    const action = subType === 'update' ? 'update' : 'new';
    const subject =
      action === 'update'
        ? `[HOMEGROWN] UPDATE_LISTING: ${targetSlug || name}`
        : `[HOMEGROWN] NEW_LISTING: ${name}`;

    if (slugInput) {
      slugInput.value = slug;
    }
    const body = buildYaml(data, action, targetSlug);
    const mailto = `mailto:josh@stonetosky.nz?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
    window.location.href = mailto;
  });
</script>

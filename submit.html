---
layout: default
title: Add or Update a Listing
permalink: /submit.html
---
<section class="form-page">
  <header class="collection-index__header">
    <p class="eyebrow">Contribute</p>
    <h1>Add or Update a Listing</h1>
    <p class="lead">Use this form to add new farms, stores, cafés, restaurants, markets, or hubs, or to update an existing listing. On submit, your email client will open with the details prefilled.</p>
  </header>

  <form id="submitForm">
    <div class="form-group">
      <label>Submission type</label>
      <div class="pill-group">
        <label class="pill pill--checkbox">
          <input type="radio" name="submission_type" value="new" checked>
          <span>Add new listing</span>
        </label>
        <label class="pill pill--checkbox">
          <input type="radio" name="submission_type" value="update">
          <span>Update existing listing</span>
        </label>
      </div>
    </div>

    <div class="form-group">
      <label for="collection">Listing category</label>
      <select id="collection" name="collection" required>
        <option value="">Select a category…</option>
        <option value="farms">Farms &amp; producers</option>
        <option value="markets">Markets</option>
        <option value="stores">Grocers / stores</option>
        <option value="restaurants">Eateries (restaurants &amp; cafés)</option>
        <option value="vendors">Food trucks / mobile vendors</option>
        <option value="distributors">Distributors / hubs</option>
      </select>
    </div>

    <div class="form-group" id="subtype-group" style="display:none">
      <label for="subtype">Subtype</label>
      <select id="subtype" name="subtype">
        <option value="">Select a subtype…</option>
        <option data-collections="restaurants" value="cafe">Cafe</option>
        <option data-collections="restaurants" value="restaurant">Restaurant</option>
        <option data-collections="vendors" value="food-truck">Food truck</option>
        <option data-collections="stores" value="supermarket">Supermarket</option>
        <option data-collections="stores" value="organic-store">Organic store</option>
        <option data-collections="stores" value="wholefoods-store">Wholefoods store</option>
        <option data-collections="stores" value="bulk-refillery">Bulk refillery</option>
        <option data-collections="stores" value="co-op">Co-op</option>
        <option data-collections="stores" value="specialty-grocer">Specialty grocer</option>
        <option data-collections="farms" value="market-garden">Market garden</option>
        <option data-collections="farms" value="orchard">Orchard</option>
        <option data-collections="farms" value="vineyard">Vineyard</option>
        <option data-collections="farms" value="livestock">Livestock</option>
        <option data-collections="farms" value="dairy-farm">Dairy farm</option>
        <option data-collections="farms" value="apiary">Apiary / honey</option>
        <option data-collections="farms" value="eggs">Eggs</option>
        <option data-collections="farms" value="mushrooms">Mushrooms</option>
        <option data-collections="farms" value="seeds">Seeds / nursery</option>
        <option data-collections="farms" value="flowers">Flowers</option>
        <option data-collections="farms" value="mixed">Mixed</option>
      </select>
    </div>

    <div class="form-group" id="specialty-group" style="display:none">
      <label>Specialty (optional)</label>
      <div class="pill-group">
        {% assign specialty_tags = "bakery,butcher,fish-monger,chocolatier,kombucha,kefir,dairy,cheese,coffee-roaster,fermenter" | split: "," %}
        {% for tag in specialty_tags %}
        <label class="pill pill--checkbox">
          <input type="checkbox" name="specialty_tags" value="{{ tag }}">
          <span>{{ tag | replace: '-', ' ' | capitalize }}</span>
        </label>
        {% endfor %}
      </div>
    </div>

    <div class="form-group">
      <label for="name">Business name</label>
      <input type="text" id="name" name="name" required>
    </div>

    <div class="form-group split">
      <div>
        <label for="country_slug">Country</label>
        <select id="country_slug" name="country_slug">
          <option value="new-zealand" selected>New Zealand</option>
          <option value="australia">Australia</option>
        </select>
      </div>
      <div>
        <label for="region">Region</label>
        <input type="text" id="region" name="region" placeholder="e.g. Wellington">
      </div>
    </div>

    <div class="form-group split">
      <div>
        <label for="city">City / town</label>
        <input type="text" id="city" name="city" placeholder="e.g. Masterton">
      </div>
      <div>
        <label for="suburb">Suburb</label>
        <input type="text" id="suburb" name="suburb" placeholder="e.g. Brooklyn">
      </div>
    </div>

    <div class="form-group">
      <label for="address">Street address</label>
      <input type="text" id="address" name="address" placeholder="123 Example St">
    </div>

    <div class="form-group split">
      <div>
        <label for="lat">Latitude</label>
        <input type="text" id="lat" name="lat" placeholder="-43.530955">
      </div>
      <div>
        <label for="lon">Longitude</label>
        <input type="text" id="lon" name="lon" placeholder="172.636434">
      </div>
    </div>
    <p class="muted" style="margin:0.25rem 0 1rem;">Coordinates help us place you on the map (e.g. copy from Google Maps).</p>

    <div class="form-group">
      <label for="postcode">Postcode (optional)</label>
      <input type="text" id="postcode" name="postcode" placeholder="e.g. 6011">
    </div>

    <div class="form-group split">
      <div>
      <label for="website">Website</label>
      <input type="text" id="website" name="website" placeholder="https:// or www.example.com">
      </div>
      <div>
        <label for="social">Social links</label>
        <textarea id="social" name="social" rows="2" placeholder="https:// (one per line or comma separated)"></textarea>
      </div>
    </div>

    <div class="form-group split">
      <div>
        <label for="email">Contact email</label>
        <input type="email" id="email" name="email" placeholder="you@example.com">
      </div>
      <div>
        <label for="phone">Contact phone</label>
        <input type="text" id="phone" name="phone" placeholder="+64...">
      </div>
    </div>

    <div class="form-group">
      <label for="short_description">Short description (card preview)</label>
      <textarea id="short_description" name="short_description" rows="3" placeholder="Shows on the listing card; 1–2 sentences."></textarea>
    </div>

    <div class="form-group">
      <label for="full_description">Full description (for the main listing page)</label>
      <textarea id="full_description" name="full_description" rows="6" placeholder="Markdown accepted."></textarea>
    </div>

    <div class="form-group">
      <label>Practices</label>
      <div class="pill-group">
        {% assign practice_tokens = "organic,spray-free,regenerative,biodynamic,wild,pasture-raised,local" | split: "," %}
        {% for tag in practice_tokens %}
        <label class="pill pill--checkbox">
          <input type="checkbox" name="practices_tags" value="{{ tag }}">
          <span>{{ tag | replace: '-', ' ' | capitalize }}</span>
        </label>
        {% endfor %}
      </div>
    </div>

    <div class="form-group">
      <label for="products">Products (one per line or comma separated)</label>
      <textarea id="products" name="products" rows="3"></textarea>
    </div>

    <div class="form-group">
      <label for="services">Services / channels (one per line or comma separated)</label>
      <textarea id="services" name="services" rows="3"></textarea>
    </div>

    <div class="form-group split">
      <div>
        <label for="hours">Hours / schedule</label>
        <textarea id="hours" name="hours" rows="2" placeholder="e.g. Mon–Fri 9–5"></textarea>
      </div>
      <div>
        <label for="market_days">Market days (one per line)</label>
        <textarea id="market_days" name="market_days" rows="2" placeholder="e.g. Sat 8–12pm"></textarea>
      </div>
    </div>

    <div class="form-group split">
      <div>
        <label for="supplies_to">Who do they supply to? (optional)</label>
        <textarea id="supplies_to" name="supplies_to" rows="2"></textarea>
      </div>
      <div>
        <label for="sources">Who do they source from? (optional)</label>
        <textarea id="sources" name="sources" rows="2"></textarea>
      </div>
    </div>

    <div class="form-group">
      <label for="updates">What needs to be updated or corrected? (for updates)</label>
      <textarea id="updates" name="updates" rows="3"></textarea>
    </div>

    <div class="form-group">
      <label for="notes">Extra comments (anything else we should know)</label>
      <textarea id="notes" name="notes" rows="3"></textarea>
    </div>

    <input type="hidden" id="slug" name="slug">

    <p id="submitError" role="alert" style="display:none; color:#b43b3b; margin:0.35rem 0 0.5rem;"></p>
    <div id="submitDebug" style="display:none; margin:0.5rem 0;">
      <p style="margin:0 0 0.4rem; color:#2d2d2d; font-size:0.95rem;">
        We tried to open your email app. If nothing happened, your browser/mail app may be blocking ‘mailto’ links.<br>
        Copy the message below, then email it to <a href="mailto:josh@stonetosky.nz">josh@stonetosky.nz</a>.
      </p>
      <textarea id="submitDebugBody" readonly rows="6" style="width:100%; font-family:monospace;"></textarea>
    </div>
    <button type="submit" class="button">Send via email</button>
  </form>
</section>

<script>
  (function () {
    const submitForm = document.getElementById('submitForm');
    if (!submitForm) return;

    const params = new URLSearchParams(window.location.search);
    const nameInput = document.getElementById('name');
    const slugInput = document.getElementById('slug');
    const submissionTypeRadios = submitForm.querySelectorAll('input[name="submission_type"]');
    const collectionSelect = document.getElementById('collection');
    const subtypeSelect = document.getElementById('subtype');
    const subtypeGroup = document.getElementById('subtype-group');
    const specialtyGroup = document.getElementById('specialty-group');
    const errorEl = document.getElementById('submitError');

    const MAILTO_TO = 'josh@stonetosky.nz';
    const MAILTO_MAX_LENGTH = 1800;
    const TRUNCATION_NOTICE = '[truncated — paste the rest manually]';
    const TRUNCATION_PREAMBLE =
      'Note: this draft was shortened to fit the email link. The YAML is intact; please paste the remaining description manually if needed.\n\n';

    // Canonical tokens: collection (farms, markets, stores, restaurants, vendors, distributors)
    // subtype is only emitted for restaurants/vendors/stores; markets have no subtype.
    // practices_tags always emitted (even empty). specialty_tags only for stores + specialty-grocer.
    const PRACTICE_TOKENS = ['organic', 'spray-free', 'regenerative', 'biodynamic', 'wild', 'pasture-raised', 'local'];
    const FARM_SUBTYPES = ['market-garden', 'orchard', 'vineyard', 'livestock', 'dairy-farm', 'apiary', 'eggs', 'mushrooms', 'seeds', 'flowers', 'mixed'];
    const RESTAURANT_SUBTYPES = ['cafe', 'restaurant'];
    const VENDOR_SUBTYPES = ['food-truck'];
    const STORE_SUBTYPES = ['supermarket', 'organic-store', 'wholefoods-store', 'bulk-refillery', 'co-op', 'specialty-grocer'];
    const SPECIALTY_TOKENS = ['bakery', 'butcher', 'fish-monger', 'chocolatier', 'kombucha', 'kefir', 'dairy', 'cheese', 'coffee-roaster', 'fermenter'];

    const listingRef = params.get('listing') || '';
    const presetName = params.get('name');
    const presetSubmissionType = params.get('submission_type');

    const showError = (message, err) => {
      if (err) console.error(err);
      if (errorEl) {
        errorEl.textContent = message;
        errorEl.style.display = 'block';
      }
    };

    const clearError = () => {
      if (errorEl) {
        errorEl.textContent = '';
        errorEl.style.display = 'none';
      }
    };

    const slugify = (value) =>
      (value || '')
        .toLowerCase()
        .trim()
        .replace(/[^a-z0-9\s-]/g, '')
        .replace(/\s+/g, '-')
        .replace(/-+/g, '-');

    const normalizeToken = (value) => (value || '').toString().trim().toLowerCase();
    const normalizeWebsite = (value) => {
      const raw = (value || '').trim();
      if (!raw) return '';
      if (/^https?:\/\//i.test(raw)) return raw;
      if (raw.startsWith('www.')) return `https://${raw}`;
      return `https://${raw}`;
    };
    const parseMaybeNumber = (value) => {
      if (value === null || value === undefined || value === '') return null;
      const num = Number(value);
      return Number.isFinite(num) ? num : null;
    };

    const splitList = (value) =>
      (value || '')
        .split(/[,\n]/)
        .map((v) => v.trim())
        .filter(Boolean);

    const uniqueAllowed = (values, allowed) => {
      const set = new Set();
      values.forEach((val) => {
        const token = normalizeToken(val);
        if (allowed.includes(token)) set.add(token);
      });
      return Array.from(set);
    };

    const clearChecked = (name) => {
      submitForm.querySelectorAll(`input[name="${name}"]`).forEach((el) => {
        el.checked = false;
      });
    };

    const updateCategoryFields = () => {
      const collection = collectionSelect ? collectionSelect.value : '';
      const subtypeAllowedCollections = ['restaurants', 'vendors', 'stores', 'farms'];
      const showSubtype = subtypeAllowedCollections.includes(collection);
      if (subtypeGroup) subtypeGroup.style.display = showSubtype ? '' : 'none';
      if (subtypeSelect) {
        const current = subtypeSelect.value;
        let keepCurrent = false;
        Array.from(subtypeSelect.options).forEach((opt) => {
          if (!opt.value) {
            opt.hidden = false;
            return;
          }
          const allowedFor = (opt.dataset.collections || '').split(',').map((v) => v.trim());
          const allowed = allowedFor.includes(collection);
          opt.hidden = !allowed;
          if (!allowed && current === opt.value) {
            subtypeSelect.value = '';
          }
          if (allowed && current === opt.value) {
            keepCurrent = true;
          }
        });
        if (!keepCurrent && !showSubtype) {
          subtypeSelect.value = '';
        }
      }

      const showSpecialty = collection === 'stores' && subtypeSelect && subtypeSelect.value === 'specialty-grocer';
      if (specialtyGroup) specialtyGroup.style.display = showSpecialty ? '' : 'none';
      if (!showSpecialty) clearChecked('specialty_tags');
    };

    const applyPrefills = () => {
      if (presetName && nameInput) {
        nameInput.value = presetName;
      } else if (listingRef && nameInput) {
        nameInput.value = listingRef;
      }
      if (listingRef && slugInput && !slugInput.value) {
        slugInput.value = listingRef;
      }

      const shouldSetUpdate =
        (presetSubmissionType && presetSubmissionType.toLowerCase().includes('update')) || Boolean(listingRef);
      if (shouldSetUpdate && submissionTypeRadios.length) {
        submissionTypeRadios.forEach((radio) => {
          radio.checked = radio.value === 'update';
        });
      }

      if (collectionSelect) {
        const presetCollection = params.get('collection');
        if (presetCollection) {
          collectionSelect.value = presetCollection;
        }
        collectionSelect.addEventListener('change', updateCategoryFields);
      }
      if (subtypeSelect) {
        subtypeSelect.addEventListener('change', updateCategoryFields);
      }
      updateCategoryFields();
    };

    const formatList = (label, items) => {
      if (!items.length) return `${label}: []`;
      return `${label}:\n${items.map((item) => `  - ${item}`).join('\n')}`;
    };

    const formatMultiline = (label, value) => {
      const text = (value || '').trim();
      return `${label}: >\n  ${text.replace(/\r?\n/g, '\n  ')}`;
    };

    const buildEmailSections = (data, action, targetSlug) => {
      const listFields = {
        products: splitList(data.get('products')),
        services: splitList(data.get('services')),
        social: splitList(data.get('social')),
        market_days: splitList(data.get('market_days')),
        supplies_to: splitList(data.get('supplies_to')),
        sources: splitList(data.get('sources'))
      };
      const name = data.get('name') || '';
      const countrySlug = data.get('country_slug') || 'new-zealand';
      const countryLabel = countrySlug === 'australia' ? 'AU' : 'New Zealand';
      const slug = targetSlug || slugify(name);
      const collection = data.get('collection') || '';
      const subtypeRaw = normalizeToken(data.get('subtype'));
      const practicesTags = uniqueAllowed(data.getAll('practices_tags'), PRACTICE_TOKENS);
      const latValue = data.get('lat') || '';
      const lonValue = data.get('lon') || '';
      const specialtyTags =
        collection === 'stores' && subtypeRaw === 'specialty-grocer'
          ? uniqueAllowed(data.getAll('specialty_tags'), SPECIALTY_TOKENS)
          : [];
      const subtypeAllowed =
        (collection === 'restaurants' && RESTAURANT_SUBTYPES.includes(subtypeRaw)) ||
        (collection === 'vendors' && VENDOR_SUBTYPES.includes(subtypeRaw)) ||
        (collection === 'stores' && STORE_SUBTYPES.includes(subtypeRaw)) ||
        (collection === 'farms' && FARM_SUBTYPES.includes(subtypeRaw));
      const subtype = subtypeAllowed ? subtypeRaw : '';
      const shortDescription = data.get('short_description') || '';
      const fullDescription = (data.get('full_description') || '').trim();
      const descriptionText = shortDescription || fullDescription;
      const submitterName = data.get('submitter_name') || '';
      const ownerName = data.get('owner_name') || '';

      const yamlLines = [
        '---',
        `title: ${name}`,
        `slug: ${slug}`,
        `collection: ${collection}`,
        subtype ? `subtype: ${subtype}` : null,
        `country_slug: ${countrySlug}`,
        `country: ${countryLabel}`,
        `region: ${data.get('region') || ''}`,
        `city: ${data.get('city') || ''}`,
        `address: ${data.get('address') || ''}`,
        `suburb: ${data.get('suburb') || ''}`,
        `postcode: ${data.get('postcode') || ''}`,
        `lat: ${latValue}`,
        `lon: ${lonValue}`,
        formatMultiline('description', descriptionText),
        formatMultiline('seo_description', data.get('seo_description')),
        formatList('practices_tags', practicesTags),
        collection === 'stores' && specialtyTags.length ? formatList('specialty_tags', specialtyTags) : null,
        formatList('products', listFields.products),
        formatList('services', listFields.services),
        `website: ${normalizeWebsite(data.get('website'))}`,
        `email: ${data.get('email') || ''}`,
        `phone: ${data.get('phone') || ''}`,
        formatList('social', listFields.social),
        `hours: ${data.get('hours') || ''}`,
        formatList('market_days', listFields.market_days),
        formatList('supplies_to', listFields.supplies_to),
        formatList('sources', listFields.sources),
        '---'
      ];
      const yamlContent = yamlLines.filter(Boolean).join('\n');

      const ownerIsContact = data.get('owner_checkbox') ? 'yes' : 'no';
      const submitterNotes = [
        '# Submitter notes',
        `owner_is_contact: ${ownerIsContact}`,
        `owner_name: ${ownerName}`,
        `submitter_name: ${submitterName}`,
        `submitter_email: ${data.get('submitter_email') || ''}`
      ];
      if (action === 'update') {
        submitterNotes.push('what_changed: |');
        submitterNotes.push(`  ${(data.get('updates') || '').replace(/\r?\n/g, '\n  ')}`);
      } else {
        submitterNotes.push('extra_comments: |');
        submitterNotes.push(`  ${(data.get('notes') || '').replace(/\r?\n/g, '\n  ')}`);
      }

      const headerLines = [
        `# ACTION: ${action === 'update' ? 'UPDATE_LISTING' : 'NEW_LISTING'}`,
        action === 'update' ? `# TARGET_SLUG: ${targetSlug || slug}` : null
      ].filter(Boolean);

      return {
        header: headerLines.join('\n'),
        yaml: yamlContent,
        fullDescription: fullDescription || '[add long-form description here]',
        notes: submitterNotes.join('\n'),
        slug,
        name
      };
    };

    const composeBody = (sections, descriptionOverride) =>
      [sections.header, sections.yaml, '# Full description (markdown)', descriptionOverride || sections.fullDescription, sections.notes].join('\n\n');

    const mailtoLength = (subject, body) =>
      `mailto:${MAILTO_TO}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`.length;

    const buildBodyWithTruncation = (subject, sections) => {
      const baseBody = composeBody(sections);
      if (mailtoLength(subject, baseBody) <= MAILTO_MAX_LENGTH) return baseBody;

      const description = sections.fullDescription || '';
      let snippet = description;
      let truncatedBody = `${TRUNCATION_PREAMBLE}${composeBody(sections, `${snippet}${snippet ? '\n\n' : ''}${TRUNCATION_NOTICE}`)}`;

      while (mailtoLength(subject, truncatedBody) > MAILTO_MAX_LENGTH && snippet.length > 80) {
        snippet = snippet.slice(0, Math.max(80, Math.floor(snippet.length * 0.7)));
        truncatedBody = `${TRUNCATION_PREAMBLE}${composeBody(
          sections,
          `${snippet}${snippet ? '\n\n' : ''}${TRUNCATION_NOTICE}`
        )}`;
      }

      if (mailtoLength(subject, truncatedBody) > MAILTO_MAX_LENGTH) {
        truncatedBody = `${TRUNCATION_PREAMBLE}${sections.header}\n\n${sections.yaml}\n\n# Full description (markdown)\n${TRUNCATION_NOTICE}\n\n${sections.notes}`;
      }

      if (mailtoLength(subject, truncatedBody) > MAILTO_MAX_LENGTH) {
        truncatedBody = `${TRUNCATION_PREAMBLE}${sections.header}\n\n${sections.yaml}\n\n${TRUNCATION_NOTICE}`;
      }

      return truncatedBody;
    };

    const buildMailtoUrl = (subject, sections) => {
      const body = buildBodyWithTruncation(subject, sections);
      return `mailto:${MAILTO_TO}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
    };

    try {
      applyPrefills();
    } catch (err) {
      showError('We had trouble preparing the form; you can still send via email.', err);
    }

    submitForm.addEventListener('submit', (e) => {
      e.preventDefault();
      clearError();
      try {
        const data = new FormData(submitForm);
        const latRaw = (data.get('lat') || '').trim();
        const lonRaw = (data.get('lon') || '').trim();
        const hasLat = latRaw !== '';
        const hasLon = lonRaw !== '';
        if (hasLat) {
          const latVal = parseMaybeNumber(latRaw);
          if (latVal === null || latVal < -90 || latVal > 90) {
            showError('Latitude must be a number between -90 and 90.');
            return;
          }
        }
        if (hasLon) {
          const lonVal = parseMaybeNumber(lonRaw);
          if (lonVal === null || lonVal < -180 || lonVal > 180) {
            showError('Longitude must be a number between -180 and 180.');
            return;
          }
        }
        const action = (data.get('submission_type') || 'new') === 'update' ? 'update' : 'new';
        const name = data.get('name') || '';
        const targetSlug = listingRef || '';
        const slug = targetSlug || slugify(name);
        if (slugInput) {
          slugInput.value = slug;
        }

        const sections = buildEmailSections(data, action, targetSlug || slug);
        const subjectToken = sections.slug || sections.name || slug || name;
        const subject = subjectToken
          ? `Homegrown Directory submission: ${subjectToken}`
          : 'Homegrown Directory submission';

        const mailtoUrl = buildMailtoUrl(subject, sections);
        console.log('[submit] mailto length:', mailtoUrl.length, 'preview:', mailtoUrl.slice(0, 200));
        const debugEl = document.getElementById('submitDebug');
        const debugBody = document.getElementById('submitDebugBody');
        if (debugEl && debugBody) {
          debugBody.value = buildBodyWithTruncation(subject, sections);
          debugEl.style.display = 'block';
        }
        window.location.href = mailtoUrl;
      } catch (err) {
        showError('Sorry, we could not prepare the email draft. Please copy your answers and email josh@stonetosky.nz.', err);
      }
    });
  })();
</script>
